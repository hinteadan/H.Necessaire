@using H.Necessaire.Runtime.UI.Razor.Core.Managers
@using H.Necessaire.Runtime.UI.Razor.Core.Storage
@inherits HRazorComponentBase
@inject HJs hjs
@code {
    [Inject(Key = "H.Necessaire.Core")] IndexedDb HNecessaireCoreIndexedDb { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        EnsureDependencies();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            EnsureDependencies();

            await InitializeConsumer();
        }
    }

    void EnsureDependencies()
    {
        App.DependencyRegistry.Register<HJs>(() => hjs);
        App.DependencyRegistry.Register<HIndexedDbContext>(() => new HIndexedDbContext
        {
            CoreDatabase = HNecessaireCoreIndexedDb,
        });
        GC.Collect();
    }

    async Task InitializeConsumer()
    {
        if (await IsConsumerReportedForThisSession())
            return;

        await Get<ImAConsumerUseCase>().CreateOrResurrect();

        await MarkConsumerReportedForThisSession();
    }

    static bool? isConsumerReportedForThisSession = null;
    async Task<bool> IsConsumerReportedForThisSession()
    {
        if (isConsumerReportedForThisSession != null)
            return isConsumerReportedForThisSession.Value;

        isConsumerReportedForThisSession = (await hjs.GetSessionValue($"H-IsConsumerReportedForThisSession")).ParseToBoolOrFallbackTo(false).Value;

        return isConsumerReportedForThisSession.Value;
    }
    async Task MarkConsumerReportedForThisSession()
    {
        await hjs.SetSessionValue("H-IsConsumerReportedForThisSession", true.ToString());
    }
}
